<div class="dashboard">
  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <p-progressSpinner></p-progressSpinner>
  </div>

  <!-- Page Header -->
  <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center mb-4">
    <div class="mb-2 md:mb-0">
      <h2 class="text-2xl font-bold text-color m-0">Dashboard Financeiro</h2>
      <p class="text-color-secondary m-0">
        {{
          isCurrentMonth
            ? 'Visão geral das suas finanças'
            : getSelectedMonthName() + ' de ' + selectedYear
        }}
      </p>
    </div>

    <!-- Navigation and Controls -->
    <div class="flex flex-column sm:flex-row gap-3 align-items-center">
      <!-- Month Navigation -->
      <div class="flex align-items-center gap-2">
        <p-button
          icon="pi pi-chevron-left"
          [rounded]="true"
          [text]="true"
          size="small"
          (onClick)="navigateToPreviousMonth()"
          pTooltip="Mês anterior"
        ></p-button>

        <div class="flex gap-2">
          <p-dropdown
            [(ngModel)]="selectedYear"
            [options]="getYearOptions()"
            placeholder="Ano"
            (onChange)="onYearChange()"
            styleClass="w-full"
            [style]="{ 'min-width': '100px' }"
          ></p-dropdown>

          <p-dropdown
            [(ngModel)]="selectedMonth"
            [options]="getMonthOptions()"
            placeholder="Mês"
            (onChange)="onMonthChange()"
            styleClass="w-full"
            [style]="{ 'min-width': '120px' }"
          ></p-dropdown>
        </div>

        <p-button
          icon="pi pi-chevron-right"
          [rounded]="true"
          [text]="true"
          size="small"
          (onClick)="navigateToNextMonth()"
          pTooltip="Próximo mês"
        ></p-button>

        <p-button
          icon="pi pi-home"
          [rounded]="true"
          [text]="true"
          size="small"
          (onClick)="navigateToCurrentMonth()"
          pTooltip="Voltar ao mês atual"
          [disabled]="isCurrentMonth"
        ></p-button>
      </div>

      <!-- Projection Toggle -->
      <div class="flex align-items-center gap-2">
        <label for="projectionToggle" class="text-sm font-semibold">Incluir Projeções:</label>
        <p-toggleButton
          id="projectionToggle"
          [(ngModel)]="includeProjections"
          onLabel="Sim"
          offLabel="Não"
          (onChange)="onProjectionToggle()"
          [style]="{ 'min-width': '80px' }"
        ></p-toggleButton>
      </div>
    </div>
  </div>

  <!-- KPI Cards (visible on all tabs) -->
  <div class="mb-4">
    <app-kpi-cards-widget
      [dashboardData]="currentStats"
      [showProjections]="includeProjections"
      [isLoading]="loading"
      [isCurrentMonth]="isCurrentMonth"
      [selectedMonthName]="getSelectedMonthName()"
      [expenseBreakdown]="expenseBreakdown"
    ></app-kpi-cards-widget>
  </div>

  <!-- Tab Navigation -->
  <p-tabView
    [(activeIndex)]="activeTabIndex"
    (onChange)="onTabChange($event)"
    styleClass="dashboard-tabs"
  >
    <!-- Tab: Visão Geral -->
    <p-tabPanel header="Visão Geral" leftIcon="pi pi-chart-line">
      <!-- Main Charts Row -->
      <div class="grid mb-4">
        <!-- Monthly Trend Chart -->
        <div class="col-12 xl:col-8">
          <app-monthly-trend-chart
            [chartData]="monthlyTrendData"
            [chartOptions]="monthlyTrendOptions"
            [isLoading]="loading"
          ></app-monthly-trend-chart>
        </div>

        <!-- Income vs Expense Pie -->
        <div class="col-12 xl:col-4">
          <app-income-expense-chart
            [chartData]="incomeVsExpenseData"
            [chartOptions]="incomeVsExpenseOptions"
            [isLoading]="loading"
            [monthlyIncome]="currentStats.totalIncome"
            [monthlyExpenses]="getActualTotalExpenses()"
            [projectedMonthlyIncome]="currentStats.projectedIncome"
            [projectedMonthlyExpenses]="currentStats.projectedExpenses"
            [showProjections]="includeProjections"
            [selectedMonthName]="getSelectedMonthName()"
            [selectedYear]="selectedYear"
          ></app-income-expense-chart>
        </div>
      </div>

      <!-- Secondary Charts Row -->
      <div class="grid mb-4">
        <!-- Category Distribution -->
        <div class="col-12 lg:col-6">
          <app-category-distribution-chart
            [chartData]="categoryPieData"
            [chartOptions]="categoryPieOptions"
            [isLoading]="loading"
          ></app-category-distribution-chart>
        </div>

        <!-- Top Expense Categories -->
        <div class="col-12 lg:col-6">
          <app-top-categories-chart
            [chartData]="expenseCategoryData"
            [chartOptions]="expenseCategoryOptions"
            [isLoading]="loading"
          ></app-top-categories-chart>
        </div>
      </div>

      <!-- Monthly Expense Breakdown Widget -->
      <div class="grid mb-4" *ngIf="expenseBreakdown.length > 0">
        <div class="col-12 lg:col-6">
          <app-monthly-expense-breakdown-widget
            [breakdownItems]="expenseBreakdown"
            [isLoading]="loading"
            [selectedMonthName]="getSelectedMonthName()"
            [selectedYear]="selectedYear"
          ></app-monthly-expense-breakdown-widget>
        </div>
        <div class="col-12 lg:col-6">
          <app-recent-transactions-widget
            [transactions]="recentTransactions"
            [isLoading]="loading"
            [selectedMonthName]="getSelectedMonthName()"
            [selectedYear]="selectedYear"
          ></app-recent-transactions-widget>
        </div>
      </div>

      <!-- Category Stats -->
      <div class="grid">
        <div class="col-12">
          <app-category-stats-widget
            [categoryStats]="topCategories"
            [isLoading]="loading"
          ></app-category-stats-widget>
        </div>
      </div>
    </p-tabPanel>

    <!-- Tab: Cartões de Crédito -->
    <p-tabPanel header="Cartões de Crédito" leftIcon="pi pi-credit-card" *ngIf="hasCardData">
      <!-- Credit Cards Section -->
      <div class="grid">
        <!-- Card Limits Widget -->
        <div class="col-12 lg:col-6" *ngIf="creditCards.length > 0">
          <app-card-limits-widget [creditCards]="creditCards"></app-card-limits-widget>
        </div>

        <!-- Invoices Widget -->
        <div class="col-12 lg:col-6" *ngIf="invoices.length > 0">
          <app-invoices-widget
            [invoices]="invoices"
            [isLoading]="loading"
            [selectedMonthName]="getSelectedMonthName()"
            [selectedYear]="selectedYear"
          ></app-invoices-widget>
        </div>

        <!-- Card Transactions Widget -->
        <div class="col-12 lg:col-6" *ngIf="cardTransactions.length > 0 || creditCards.length > 0">
          <app-card-transactions-widget
            [transactions]="cardTransactions"
            [currentPeriod]="currentCardPeriod"
          ></app-card-transactions-widget>
        </div>

        <!-- Installments Widget -->
        <div class="col-12 lg:col-6" *ngIf="cardInstallments.length > 0">
          <app-installments-widget [installments]="cardInstallments"></app-installments-widget>
        </div>
      </div>
    </p-tabPanel>

    <!-- Tab: Financiamentos -->
    <p-tabPanel header="Financiamentos" leftIcon="pi pi-wallet" *ngIf="hasFinancingData">
      <!-- Financings Summary Section -->
      <div class="grid mb-4">
        <div class="col-12">
          <app-financings-summary-widget
            [installmentStats]="installmentStats"
            [isLoading]="loading"
            (navigateToInstallments)="navigateToInstallments()"
          ></app-financings-summary-widget>
        </div>
      </div>

      <!-- Upcoming Payments and Paid Installments Widgets -->
      <div class="grid mb-4">
        <div class="col-12 lg:col-6">
          <app-upcoming-payments-widget
            [upcomingPayments]="installmentStats.upcomingPayments"
            [isLoading]="loading"
          ></app-upcoming-payments-widget>
        </div>
        <div class="col-12 lg:col-6">
          <app-paid-installments-widget
            [paidInstallments]="installmentStats.paidInMonth"
            [isLoading]="loading"
            [selectedMonthName]="getSelectedMonthName()"
            [selectedYear]="selectedYear"
          ></app-paid-installments-widget>
        </div>
      </div>

      <!-- Installment Plans List -->
      <div class="grid">
        <div class="col-12">
          <app-installment-plans-widget
            [installmentPlans]="installmentPlans"
            [isLoading]="loading"
          ></app-installment-plans-widget>
        </div>
      </div>
    </p-tabPanel>
  </p-tabView>
</div>
