<div class="dashboard">
  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <p-progressSpinner></p-progressSpinner>
  </div>

  <!-- Page Header -->
  <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center mb-4">
    <div class="mb-2 md:mb-0">
      <h2 class="text-2xl font-bold text-color m-0">Dashboard Financeiro</h2>
      <p class="text-color-secondary m-0">{{ isCurrentMonth ? 'Visão geral das suas finanças' : getSelectedMonthName() + ' de ' + selectedYear }}</p>
    </div>
    
    <!-- Navigation and Controls -->
    <div class="flex flex-column sm:flex-row gap-3 align-items-center">
      <!-- Month Navigation -->
      <div class="flex align-items-center gap-2">
        <p-button 
          icon="pi pi-chevron-left" 
          [rounded]="true" 
          [text]="true"
          size="small"
          (onClick)="navigateToPreviousMonth()"
          pTooltip="Mês anterior"
        ></p-button>
        
        <div class="flex gap-2">
          <p-dropdown
            [(ngModel)]="selectedYear"
            [options]="getYearOptions()"
            placeholder="Ano"
            (onChange)="onYearChange()"
            styleClass="w-full"
            [style]="{'min-width': '100px'}"
          ></p-dropdown>
          
          <p-dropdown
            [(ngModel)]="selectedMonth"
            [options]="getMonthOptions()"
            placeholder="Mês"
            (onChange)="onMonthChange()"
            styleClass="w-full"
            [style]="{'min-width': '120px'}"
          ></p-dropdown>
        </div>
        
        <p-button 
          icon="pi pi-chevron-right" 
          [rounded]="true" 
          [text]="true"
          size="small"
          (onClick)="navigateToNextMonth()"
          pTooltip="Próximo mês"
        ></p-button>
        
        <p-button 
          icon="pi pi-home" 
          [rounded]="true" 
          [text]="true"
          size="small"
          (onClick)="navigateToCurrentMonth()"
          pTooltip="Voltar ao mês atual"
          [disabled]="isCurrentMonth"
        ></p-button>
      </div>
      
      <!-- Projection Toggle -->
      <div class="flex align-items-center gap-2">
        <label for="projectionToggle" class="text-sm font-semibold">Incluir Projeções:</label>
        <p-toggleButton 
          id="projectionToggle"
          [(ngModel)]="includeProjections"
          onLabel="Sim" 
          offLabel="Não"
          (onChange)="onProjectionToggle()"
          [style]="{'min-width': '80px'}"
        ></p-toggleButton>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="grid mb-4">
    <div class="col-12 sm:col-6 lg:col-3">
      <div class="kpi-card surface-card shadow-2 border-round-lg p-3 text-center">
        <div class="flex align-items-center justify-content-center mb-2">
          <i class="pi pi-arrow-up text-green-600 text-2xl"></i>
        </div>
        <div class="text-green-600 font-bold text-xl mb-1">
          {{ formatCurrency(includeProjections ? getTotalProjectedIncome() : currentStats.totalIncome) }}
        </div>
        <div class="text-color-secondary font-semibold">Receitas {{ isCurrentMonth ? 'do Mês' : 'de ' + getSelectedMonthName() }}</div>
        <div *ngIf="includeProjections && currentStats.hasProjections" class="text-xs text-blue-600 mt-1">
          + {{ formatCurrency(currentStats.projectedIncome) }} projetado
        </div>
      </div>
    </div>
    
    <div class="col-12 sm:col-6 lg:col-3">
      <div class="kpi-card surface-card shadow-2 border-round-lg p-3 text-center">
        <div class="flex align-items-center justify-content-center mb-2">
          <i class="pi pi-arrow-down text-red-600 text-2xl"></i>
        </div>
        <div class="text-red-600 font-bold text-xl mb-1">
          {{ formatCurrency(includeProjections ? getTotalProjectedExpenses() : currentStats.totalExpenses) }}
        </div>
        <div class="text-color-secondary font-semibold">Despesas {{ isCurrentMonth ? 'do Mês' : 'de ' + getSelectedMonthName() }}</div>
        <div *ngIf="includeProjections && currentStats.hasProjections" class="text-xs text-orange-600 mt-1">
          + {{ formatCurrency(currentStats.projectedExpenses) }} projetado
        </div>
      </div>
    </div>
    
    <div class="col-12 sm:col-6 lg:col-3">
      <div class="kpi-card surface-card shadow-2 border-round-lg p-3 text-center">
        <div class="flex align-items-center justify-content-center mb-2">
          <i class="pi pi-wallet" [class]="getBalanceClass() + ' text-2xl'"></i>
        </div>
        <div [class]="getBalanceClass() + ' font-bold text-xl mb-1'">
          {{ formatCurrency(includeProjections ? getTotalProjectedBalance() : currentStats.balance) }}
        </div>
        <div class="text-color-secondary font-semibold">Saldo {{ isCurrentMonth ? 'do Mês' : 'de ' + getSelectedMonthName() }}</div>
        <div *ngIf="includeProjections && currentStats.hasProjections" [class]="'text-xs mt-1 ' + getProjectionClass(currentStats.projectedBalance)">
          {{ currentStats.projectedBalance >= 0 ? '+' : '' }} {{ formatCurrency(currentStats.projectedBalance) }} projetado
        </div>
      </div>
    </div>
    
    <div class="col-12 sm:col-6 lg:col-3">
      <div class="kpi-card surface-card shadow-2 border-round-lg p-3 text-center">
        <div class="flex align-items-center justify-content-center mb-2">
          <i class="pi pi-list text-blue-600 text-2xl"></i>
        </div>
        <div class="text-blue-600 font-bold text-xl mb-1">
          {{ includeProjections ? (currentStats.transactionCount + currentStats.projectedTransactionCount) : currentStats.transactionCount }}
        </div>
        <div class="text-color-secondary font-semibold">Transações</div>
        <div *ngIf="includeProjections && currentStats.hasProjections" class="text-xs text-blue-600 mt-1">
          + {{ currentStats.projectedTransactionCount }} projetadas
        </div>
      </div>
    </div>
  </div>

  <!-- Main Charts Row -->
  <div class="grid mb-4">
    <!-- Monthly Trend Chart -->
    <div class="col-12 xl:col-8">
      <div class="chart-card surface-card shadow-2 border-round-lg">
        <div class="chart-header p-4 border-bottom-1 surface-border">
          <h5 class="font-bold text-color m-0">Tendência Mensal</h5>
          <p class="text-color-secondary text-sm m-0">Evolução de receitas, despesas e saldo ao longo do ano</p>
        </div>
        <div class="chart-content p-4">
          <div class="chart-wrapper" style="position: relative; height: 400px; width: 100%;">
            <p-chart 
              type="line" 
              [data]="monthlyTrendData" 
              [options]="monthlyTrendOptions"
              [style]="{'height': '100%', 'width': '100%'}"
            ></p-chart>
          </div>
        </div>
      </div>
    </div>

    <!-- Income vs Expense Pie -->
    <div class="col-12 xl:col-4">
      <div class="chart-card surface-card shadow-2 border-round-lg">
        <div class="chart-header p-4 border-bottom-1 surface-border">
          <h5 class="font-bold text-color m-0">Receitas vs Despesas</h5>
          <p class="text-color-secondary text-sm m-0">Distribuição anual</p>
        </div>
        <div class="chart-content p-4">
          <div class="chart-wrapper" style="position: relative; height: 400px; width: 100%;">
            <p-chart 
              type="doughnut" 
              [data]="incomeVsExpenseData" 
              [options]="incomeVsExpenseOptions"
              [style]="{'height': '100%', 'width': '100%'}"
            ></p-chart>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Secondary Charts Row -->
  <div class="grid mb-4">
    <!-- Category Distribution -->
    <div class="col-12 lg:col-6">
      <div class="chart-card surface-card shadow-2 border-round-lg">
        <div class="chart-header p-4 border-bottom-1 surface-border">
          <h5 class="font-bold text-color m-0">Distribuição por Categorias</h5>
          <p class="text-color-secondary text-sm m-0">Top categorias do mês atual</p>
        </div>
        <div class="chart-content p-4">
          <div class="chart-wrapper" style="position: relative; height: 350px; width: 100%;">
            <p-chart 
              type="pie" 
              [data]="categoryPieData" 
              [options]="categoryPieOptions"
              [style]="{'height': '100%', 'width': '100%'}"
            ></p-chart>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Expense Categories -->
    <div class="col-12 lg:col-6">
      <div class="chart-card surface-card shadow-2 border-round-lg">
        <div class="chart-header p-4 border-bottom-1 surface-border">
          <h5 class="font-bold text-color m-0">Top Categorias</h5>
          <p class="text-color-secondary text-sm m-0">Maiores gastos por categoria</p>
        </div>
        <div class="chart-content p-4">
          <div class="chart-wrapper" style="position: relative; height: 400px; width: 100%;">
            <p-chart 
              type="bar" 
              [data]="expenseCategoryData" 
              [options]="expenseCategoryOptions"
              [style]="{'height': '100%', 'width': '100%'}"
            ></p-chart>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Tables Row -->
  <div class="grid">
    <!-- Recent Transactions -->
    <div class="col-12 lg:col-7">
      <div class="data-card surface-card shadow-2 border-round-lg">
        <div class="card-header p-4 border-bottom-1 surface-border">
          <div class="flex justify-content-between align-items-center">
            <div>
              <h5 class="font-bold text-color m-0">Transações Recentes</h5>
              <p class="text-color-secondary text-sm m-0">Últimas movimentações</p>
            </div>
            <p-button 
              label="Ver Todas" 
              icon="pi pi-external-link" 
              [text]="true"
              size="small"
              routerLink="/transactions"
            ></p-button>
          </div>
        </div>
        <div class="card-content p-4">
          <div class="transaction-list" *ngIf="recentTransactions.length > 0">
            <div 
              class="transaction-item flex justify-content-between align-items-center py-2 px-3 border-round hover:surface-hover cursor-pointer"
              *ngFor="let transaction of recentTransactions"
            >
              <div class="flex align-items-center gap-3">
                <i 
                  [class]="transaction.category.icon" 
                  [style.color]="transaction.category.color"
                  class="text-lg"
                ></i>
                <div>
                  <div class="font-semibold text-color">{{ transaction.description }}</div>
                  <div class="text-color-secondary text-sm">
                    {{ transaction.category.name }} • {{ formatDate(transaction.transactionDate) }}
                  </div>
                </div>
              </div>
              <div class="text-right">
                <div [class]="'font-bold ' + (transaction.type === 'income' ? 'text-green-600' : 'text-red-600')">
                  {{ transaction.type === 'income' ? '+' : '-' }}{{ formatCurrency(transaction.amount) }}
                </div>
              </div>
            </div>
          </div>
          <div class="text-center py-4 text-color-secondary" *ngIf="recentTransactions.length === 0">
            Nenhuma transação encontrada
          </div>
        </div>
      </div>
    </div>

    <!-- Upcoming Recurring -->
    <div class="col-12 lg:col-5">
      <div class="data-card surface-card shadow-2 border-round-lg">
        <div class="card-header p-4 border-bottom-1 surface-border">
          <div class="flex justify-content-between align-items-center">
            <div>
              <h5 class="font-bold text-color m-0">Próximas Recorrências</h5>
              <p class="text-color-secondary text-sm m-0">Transações agendadas</p>
            </div>
            <p-button 
              label="Ver Todas" 
              icon="pi pi-external-link" 
              [text]="true"
              size="small"
              routerLink="/recurring-transactions"
            ></p-button>
          </div>
        </div>
        <div class="card-content p-4">
          <div class="recurring-list" *ngIf="upcomingRecurring.length > 0">
            <div 
              class="recurring-item flex justify-content-between align-items-center py-2 px-3 border-round hover:surface-hover cursor-pointer"
              *ngFor="let recurring of upcomingRecurring"
            >
              <div class="flex align-items-center gap-3">
                <i 
                  [class]="recurring.category.icon" 
                  [style.color]="recurring.category.color"
                  class="text-lg"
                ></i>
                <div>
                  <div class="font-semibold text-color">{{ recurring.description }}</div>
                  <div class="text-color-secondary text-sm">
                    {{ formatDate(recurring.nextExecution) }}
                    <span [class]="isOverdue(recurring) ? 'text-red-600 font-bold' : ''">
                      ({{ isOverdue(recurring) ? 'Atrasada' : getDaysUntilExecution(recurring) + ' dias' }})
                    </span>
                  </div>
                </div>
              </div>
              <div class="text-right">
                <div [class]="'font-bold ' + (recurring.type === 'income' ? 'text-green-600' : 'text-red-600')">
                  {{ recurring.type === 'income' ? '+' : '-' }}{{ formatCurrency(recurring.amount) }}
                </div>
                <div class="text-xs text-color-secondary">
                  {{ recurring.frequency }}
                </div>
              </div>
            </div>
          </div>
          <div class="text-center py-4 text-color-secondary" *ngIf="upcomingRecurring.length === 0">
            Nenhuma recorrência agendada
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Category Stats -->
  <div class="grid mt-4" *ngIf="topCategories.length > 0">
    <div class="col-12">
      <div class="surface-card shadow-2 border-round-lg">
        <div class="card-header p-4 border-bottom-1 surface-border">
          <h5 class="font-bold text-color m-0">Estatísticas por Categoria</h5>
          <p class="text-color-secondary text-sm m-0">Detalhamento dos gastos do mês atual</p>
        </div>
        <div class="card-content p-4">
          <div class="grid">
            <div 
              class="col-12 sm:col-6 lg:col-4 xl:col-3"
              *ngFor="let category of topCategories.slice(0, 8)"
            >
              <div class="category-stat-card p-3 border-round surface-hover">
                <div class="flex align-items-center gap-3 mb-2">
                  <i 
                    [class]="category.categoryIcon" 
                    [style.color]="category.categoryColor"
                    class="text-xl"
                  ></i>
                  <div class="flex-grow-1">
                    <div class="font-semibold text-color">{{ category.categoryName }}</div>
                    <div class="text-color-secondary text-sm">{{ category.transactionCount }} transação(ões)</div>
                  </div>
                </div>
                <div class="mb-2">
                  <div class="font-bold text-lg">{{ formatCurrency(category.amount) }}</div>
                  <div class="text-color-secondary text-sm">{{ category.percentage.toFixed(1) }}% do total</div>
                </div>
                <p-progressBar 
                  [value]="category.percentage" 
                  [showValue]="false"
                  [style]="{'height': '6px'}"
                ></p-progressBar>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>