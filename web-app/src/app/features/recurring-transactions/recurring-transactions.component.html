<div class="card">
  <!-- Page Header -->
  <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center mb-4">
    <div class="mb-2 md:mb-0">
      <h2 class="text-2xl font-bold text-color m-0">Transações Recorrentes</h2>
      <p class="text-color-secondary m-0">Gerencie transações automáticas e recorrentes</p>
    </div>
    <div class="flex gap-2">
      <p-button 
        label="Nova Recorrência" 
        icon="pi pi-plus" 
        size="small"
        (onClick)="openNew()"
      ></p-button>
    </div>
  </div>

  <!-- Recurring Transactions Cards -->
  <div class="grid" *ngIf="!loading && recurringTransactions.length > 0">
    <div 
      class="col-12 lg:col-6 xl:col-4" 
      *ngFor="let transaction of recurringTransactions"
    >
      <div class="recurring-card surface-card border-round-lg shadow-2 p-4 h-full">
        <div class="flex flex-column h-full">
          <!-- Card Header -->
          <div class="flex align-items-start justify-content-between mb-3">
            <div class="flex-grow-1">
              <div class="flex align-items-center gap-2 mb-2">
                <i 
                  [class]="transaction.category.icon" 
                  [style.color]="transaction.category.color"
                  class="text-lg"
                ></i>
                <h4 class="font-bold text-lg m-0">{{ transaction.description }}</h4>
              </div>
              <span 
                [class]="getTransactionTypeClass(transaction.type)" 
                class="font-bold text-xl"
              >
                {{ formatCurrency(transaction.amount) }}
              </span>
            </div>
            <div class="flex flex-column gap-1 align-items-end">
              <p-tag 
                [value]="getStatusLabel(transaction)"
                [severity]="getStatusSeverity(transaction)"
                [rounded]="true"
              ></p-tag>
              <p-tag 
                [value]="getTransactionTypeLabel(transaction.type)"
                [severity]="transaction.type === 'income' ? 'success' : 'danger'"
                [rounded]="true"
              ></p-tag>
            </div>
          </div>

          <!-- Transaction Details -->
          <div class="flex-grow-1 mb-3">
            <div class="grid text-sm">
              <div class="col-12 mb-2">
                <div class="flex align-items-center gap-2 mb-1">
                  <i class="pi pi-tag text-color-secondary"></i>
                  <span class="font-semibold">Categoria:</span>
                  <span>{{ transaction.category.name }}</span>
                </div>
              </div>
              
              <div class="col-6">
                <div class="flex align-items-center gap-2 mb-1">
                  <i class="pi pi-clock text-color-secondary"></i>
                  <span class="font-semibold">Frequência:</span>
                </div>
                <span class="text-color-secondary">
                  {{ formatFrequency(transaction.frequency, transaction.interval) }}
                </span>
              </div>
              
              <div class="col-6">
                <div class="flex align-items-center gap-2 mb-1">
                  <i class="pi pi-calendar text-color-secondary"></i>
                  <span class="font-semibold">Próxima:</span>
                </div>
                <span 
                  [class]="isOverdue(transaction) ? 'text-red-600 font-bold' : 'text-color-secondary'"
                >
                  {{ transaction.nextExecution ? formatDate(transaction.nextExecution) : 'N/A' }}
                </span>
                <div *ngIf="transaction.nextExecution && transaction.isActive && !transaction.isCompleted" class="text-xs mt-1">
                  <span [class]="isOverdue(transaction) ? 'text-red-600' : 'text-color-secondary'">
                    {{ isOverdue(transaction) ? 'Atrasada' : getDaysUntilExecution(transaction) + ' dias' }}
                  </span>
                </div>
              </div>
              
              <div class="col-6" *ngIf="transaction.executionCount > 0">
                <div class="flex align-items-center gap-2 mb-1">
                  <i class="pi pi-check-circle text-color-secondary"></i>
                  <span class="font-semibold">Execuções:</span>
                </div>
                <span class="text-color-secondary">
                  {{ transaction.executionCount }}
                  <span *ngIf="transaction.maxExecutions">
                    / {{ transaction.maxExecutions }}
                  </span>
                </span>
              </div>
              
              <div class="col-6" *ngIf="transaction.endDate">
                <div class="flex align-items-center gap-2 mb-1">
                  <i class="pi pi-calendar-times text-color-secondary"></i>
                  <span class="font-semibold">Fim:</span>
                </div>
                <span class="text-color-secondary">
                  {{ formatDate(transaction.endDate) }}
                </span>
              </div>
            </div>

            <!-- Progress Bar -->
            <div *ngIf="transaction.maxExecutions && transaction.executionCount > 0" class="mt-2">
              <small class="text-color-secondary">Progresso</small>
              <div class="progress-bar-container" style="height: 8px; background-color: var(--surface-300); border-radius: 4px; overflow: hidden;">
                <div class="progress-bar-fill" 
                     [style]="{'width': getExecutionProgress(transaction) + '%', 'height': '100%', 'background-color': 'var(--primary-color)', 'transition': 'width 0.3s ease'}">
                </div>
              </div>
            </div>

            <!-- Notes -->
            <div *ngIf="transaction.notes" class="mt-2">
              <small class="text-color-secondary block mb-1">Observações:</small>
              <p class="text-sm text-color-secondary m-0 line-height-3">
                {{ transaction.notes }}
              </p>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex justify-content-between align-items-center pt-2 border-top-1 surface-border">
            <div class="flex gap-1">
              <p-button 
                icon="pi pi-pencil" 
                severity="secondary"
                size="small"
                [text]="true"
                (onClick)="editTransaction(transaction)"
                pTooltip="Editar"
              ></p-button>
              <p-button 
                [icon]="transaction.isActive ? 'pi pi-pause' : 'pi pi-play'" 
                [severity]="transaction.isActive ? 'warning' : 'success'"
                size="small"
                [text]="true"
                (onClick)="toggleActive(transaction)"
                [title]="transaction.isActive ? 'Pausar' : 'Ativar'"
                [disabled]="transaction.isCompleted"
              ></p-button>
              <p-button 
                icon="pi pi-play" 
                severity="info"
                size="small"
                [text]="true"
                (onClick)="executeTransaction(transaction)"
                pTooltip="Executar Agora"
                [disabled]="!transaction.isActive || transaction.isCompleted"
              ></p-button>
              <p-button 
                icon="pi pi-trash" 
                severity="danger"
                size="small"
                [text]="true"
                (onClick)="deleteTransaction(transaction)"
                pTooltip="Excluir"
              ></p-button>
            </div>
            
            <div class="flex align-items-center gap-2">
              <i 
                *ngIf="isOverdue(transaction)" 
                class="pi pi-exclamation-triangle text-orange-500"
                pTooltip="Transação atrasada"
              ></i>
              <small class="text-color-secondary">
                Criada em {{ formatDate(transaction.createdAt) }}
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="flex justify-content-center py-8" *ngIf="loading">
    <p-progressSpinner></p-progressSpinner>
  </div>

  <!-- Empty State -->
  <div class="text-center py-8" *ngIf="!loading && recurringTransactions.length === 0">
    <div class="flex flex-column align-items-center gap-3">
      <i class="pi pi-refresh text-6xl text-color-secondary"></i>
      <h3 class="text-color-secondary m-0">Nenhuma transação recorrente</h3>
      <p class="text-color-secondary mb-4">
        Crie transações recorrentes para automatizar receitas e despesas regulares
      </p>
      <p-button 
        label="Criar Primeira Recorrência" 
        icon="pi pi-plus" 
        (onClick)="openNew()"
      ></p-button>
    </div>
  </div>
</div>

<!-- Transaction Dialog -->
<p-dialog 
  [(visible)]="transactionDialog" 
  [header]="editMode ? 'Editar Transação Recorrente' : 'Nova Transação Recorrente'"
  [modal]="true" 
  [closable]="true"
  [style]="{ width: '800px' }"
  [maximizable]="false"
  [breakpoints]="{'960px': '90vw', '640px': '95vw'}"
>
  <form [formGroup]="transactionForm" class="grid">
    <!-- Basic Information -->
    <div class="col-12">
      <h5 class="text-primary mb-3">Informações Básicas</h5>
    </div>
    
    <div class="field col-12">
      <label for="description" class="font-bold">
        Descrição <span class="required-asterisk">*</span>
      </label>
      <input 
        id="description"
        type="text" 
        pInputText 
        formControlName="description"
        class="w-full"
        placeholder="Ex: Aluguel, Salário, Conta de Luz..."
        [class.ng-dirty]="submitted && transactionForm.get('description')?.invalid"
      />
      <small 
        class="text-red-500" 
        *ngIf="submitted && transactionForm.get('description')?.invalid"
      >
        Descrição é obrigatória
      </small>
    </div>
    
    <div class="field col-12 md:col-6">
      <label for="amount" class="font-bold">
        Valor <span class="required-asterisk">*</span>
      </label>
      <p-inputNumber
        id="amount"
        formControlName="amount"
        mode="currency"
        currency="BRL"
        locale="pt-BR"
        styleClass="w-full"
        [class.ng-dirty]="submitted && transactionForm.get('amount')?.invalid"
      ></p-inputNumber>
      <small 
        class="text-red-500" 
        *ngIf="submitted && transactionForm.get('amount')?.invalid"
      >
        Valor deve ser maior que zero
      </small>
    </div>
    
    <div class="field col-12 md:col-6">
      <label for="type" class="font-bold">
        Tipo <span class="required-asterisk">*</span>
      </label>
      <p-dropdown
        id="type"
        formControlName="type"
        [options]="transactionTypes"
        placeholder="Selecione o tipo"
        styleClass="w-full"
        (onChange)="onTypeChange()"
      ></p-dropdown>
    </div>
    
    <div class="field col-12">
      <label for="categoryId" class="font-bold">
        Categoria <span class="required-asterisk">*</span>
      </label>
      <p-dropdown
        id="categoryId"
        formControlName="categoryId"
        [options]="getCategoryOptionsForCurrentType()"
        placeholder="Selecione a categoria"
        styleClass="w-full"
        [class.ng-dirty]="submitted && transactionForm.get('categoryId')?.invalid"
      >
        <ng-template let-category pTemplate="selectedItem">
          <div class="flex align-items-center gap-2" *ngIf="category">
            <i [class]="category.icon" [style.color]="category.color"></i>
            <span>{{ category.label }}</span>
          </div>
        </ng-template>
        <ng-template let-category pTemplate="item">
          <div class="flex align-items-center gap-2">
            <i [class]="category.icon" [style.color]="category.color"></i>
            <span>{{ category.label }}</span>
          </div>
        </ng-template>
      </p-dropdown>
      <small 
        class="text-red-500" 
        *ngIf="submitted && transactionForm.get('categoryId')?.invalid"
      >
        Categoria é obrigatória
      </small>
    </div>

    <!-- Scheduling -->
    <div class="col-12">
      <h5 class="text-primary mb-3 mt-4">Agendamento</h5>
    </div>
    
    <div class="field col-12 md:col-6">
      <label for="frequency" class="font-bold">
        Frequência <span class="text-red-500">*</span>
      </label>
      <p-dropdown
        id="frequency"
        formControlName="frequency"
        [options]="frequencyOptions"
        placeholder="Selecione a frequência"
        styleClass="w-full"
        (onChange)="calculateNextExecution()"
      ></p-dropdown>
    </div>
    
    <div class="field col-12 md:col-6">
      <label for="interval" class="font-bold">
        Intervalo <span class="text-red-500">*</span>
      </label>
      <p-inputNumber
        id="interval"
        formControlName="interval"
        [min]="1"
        [max]="100"
        styleClass="w-full"
        placeholder="1"
        suffix=" vezes"
        (onInput)="calculateNextExecution()"
      ></p-inputNumber>
      <small class="text-color-secondary">
        A cada quantas vezes da frequência (ex: a cada 2 meses)
      </small>
    </div>
    
    <div class="field col-12 md:col-6">
      <label for="nextExecution" class="font-bold">
        Próxima Execução <span class="text-red-500">*</span>
      </label>
      <p-calendar
        id="nextExecution"
        formControlName="nextExecution"
        dateFormat="dd/mm/yy"
        styleClass="w-full"
        [showIcon]="true"
        [showTime]="true"
        hourFormat="24"
        appendTo="body"
      ></p-calendar>
    </div>
    
    <div class="field col-12 md:col-6">
      <label for="endDate" class="font-bold">Data de Fim</label>
      <p-calendar
        id="endDate"
        formControlName="endDate"
        dateFormat="dd/mm/yy"
        styleClass="w-full"
        [showIcon]="true"
        placeholder="Opcional"
        appendTo="body"
      ></p-calendar>
      <small class="text-color-secondary">
        Data limite para execução automática
      </small>
    </div>
    
    <div class="field col-12 md:col-6">
      <label for="maxExecutions" class="font-bold">Máximo de Execuções</label>
      <p-inputNumber
        id="maxExecutions"
        formControlName="maxExecutions"
        [min]="1"
        [max]="1000"
        styleClass="w-full"
        placeholder="Ilimitado"
        suffix=" vezes"
      ></p-inputNumber>
      <small class="text-color-secondary">
        Quantidade máxima de execuções
      </small>
    </div>
    
    <div class="field col-12 md:col-6 flex align-items-center">
      <p-checkbox 
        formControlName="isActive"
        binary="true"
        inputId="isActive"
      ></p-checkbox>
      <label for="isActive" class="ml-2 font-bold">
        Ativar imediatamente
      </label>
    </div>
    
    <div class="field col-12">
      <label for="notes" class="font-bold">Observações</label>
      <textarea 
        id="notes"
        pInputTextarea 
        formControlName="notes"
        rows="3"
        class="w-full"
        placeholder="Observações adicionais sobre esta transação recorrente..."
      ></textarea>
    </div>
  </form>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-content-end gap-2">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        severity="secondary"
        (onClick)="hideDialog()"
      ></p-button>
      <p-button 
        label="Salvar" 
        icon="pi pi-check" 
        (onClick)="saveTransaction()"
        [loading]="loading"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>