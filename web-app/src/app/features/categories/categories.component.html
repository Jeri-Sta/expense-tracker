<div class="card">
  <!-- Page Header -->
  <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center mb-4">
    <div class="mb-2 md:mb-0">
      <h2 class="text-2xl font-bold text-color m-0">Categorias</h2>
      <p class="text-color-secondary m-0">Gerencie as categorias de receitas e despesas</p>
    </div>
    <div class="flex gap-2">
      <p-button 
        label="Categorias Padrão" 
        icon="pi pi-plus-circle" 
        severity="secondary"
        size="small"
        (onClick)="createDefaultCategories()"
      ></p-button>
      <p-button 
        label="Nova Categoria" 
        icon="pi pi-plus" 
        size="small"
        (onClick)="openNew()"
      ></p-button>
    </div>
  </div>

  <!-- Type Filter -->
  <div class="card mb-4">
    <h5>Filtros</h5>
    <div class="flex gap-2 flex-wrap">
      <p-button 
        label="Todas" 
        [outlined]="selectedType !== undefined"
        size="small"
        (onClick)="filterByType(undefined)"
      ></p-button>
      <p-button 
        label="Receitas" 
        [outlined]="selectedType !== 'income'"
        severity="success"
        size="small"
        (onClick)="filterByType('income')"
      ></p-button>
      <p-button 
        label="Despesas" 
        [outlined]="selectedType !== 'expense'"
        severity="danger"
        size="small"
        (onClick)="filterByType('expense')"
      ></p-button>
    </div>
  </div>

  <!-- Categories Grid -->
  <div class="grid" *ngIf="!loading && categories.length > 0">
    <div 
      class="col-12 sm:col-6 lg:col-4 xl:col-3" 
      *ngFor="let category of categories"
    >
      <div class="category-card surface-card border-round-lg shadow-2 p-3 h-full">
        <div class="flex flex-column h-full">
          <!-- Category Header -->
          <div class="flex align-items-center justify-content-between mb-3">
            <div class="flex align-items-center gap-2">
              <i 
                [class]="normalizeIcon(category.icon)" 
                [style.color]="category.color"
                class="text-xl"
              ></i>
              <span class="font-bold text-lg">{{ category.name }}</span>
            </div>
            <p-tag 
              [value]="getStatusLabel(category.isActive)"
              [severity]="getStatusSeverity(category.isActive)"
              [rounded]="true"
            ></p-tag>
          </div>

          <!-- Category Info -->
          <div class="flex-grow-1">
            <div class="mb-2">
              <p-tag 
                [value]="getCategoryTypeLabel(category.type)"
                [severity]="category.type === 'income' ? 'success' : 'danger'"
                [rounded]="true"
              ></p-tag>
            </div>
            
            <p class="text-color-secondary text-sm mb-2" *ngIf="category.description">
              {{ category.description }}
            </p>
            
            <div class="text-xs text-color-secondary mb-3">
              <div *ngIf="category.transactionCount !== undefined">
                {{ category.transactionCount }} transação(ões)
              </div>
              <div>Ordem: {{ category.sortOrder }}</div>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex justify-content-between align-items-center">
            <div class="flex gap-1">
              <p-button 
                icon="pi pi-pencil" 
                severity="secondary"
                size="small"
                [text]="true"
                (onClick)="editCategory(category)"
                pTooltip="Editar"
              ></p-button>
              <p-button 
                *ngIf="!category.isActive"
                icon="pi pi-check" 
                severity="success"
                size="small"
                [text]="true"
                (onClick)="reactivateCategory(category)"
                pTooltip="Reativar"
              ></p-button>
              <p-button 
                icon="pi pi-trash" 
                severity="danger"
                size="small"
                [text]="true"
                (onClick)="deleteCategory(category)"
                pTooltip="Excluir"
              ></p-button>
            </div>
            <div class="color-preview" [style.background-color]="category.color"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="flex justify-content-center py-8" *ngIf="loading">
    <p-progressSpinner></p-progressSpinner>
  </div>

  <!-- Empty State -->
  <div class="text-center py-8" *ngIf="!loading && categories.length === 0">
    <div class="flex flex-column align-items-center gap-3">
      <i class="pi pi-info-circle text-6xl text-color-secondary"></i>
      <h3 class="text-color-secondary m-0">Nenhuma categoria encontrada</h3>
      <p class="text-color-secondary mb-4">
        Crie sua primeira categoria ou use as categorias padrão para começar
      </p>
      <div class="flex gap-2">
        <p-button 
          label="Categorias Padrão" 
          icon="pi pi-plus-circle" 
          severity="secondary"
          (onClick)="createDefaultCategories()"
        ></p-button>
        <p-button 
          label="Nova Categoria" 
          icon="pi pi-plus" 
          (onClick)="openNew()"
        ></p-button>
      </div>
    </div>
  </div>
</div>

<!-- Category Dialog -->
<p-dialog 
  [(visible)]="categoryDialog" 
  [header]="editMode ? 'Editar Categoria' : 'Nova Categoria'"
  [modal]="true" 
  [closable]="true"
  [style]="{ width: '600px' }"
  [maximizable]="false"
  [breakpoints]="{'960px': '75vw', '640px': '90vw'}"
>
  <form [formGroup]="categoryForm" class="grid">
    <div class="field col-12 md:col-8">
      <label for="name" class="font-bold">
        Nome <span class="required-asterisk">*</span>
      </label>
      <input 
        id="name"
        type="text" 
        pInputText 
        formControlName="name"
        class="w-full"
        placeholder="Digite o nome da categoria"
        [class.ng-dirty]="submitted && categoryForm.get('name')?.invalid"
      />
      <small 
        class="text-red-500" 
        *ngIf="submitted && categoryForm.get('name')?.invalid"
      >
        Nome é obrigatório
      </small>
    </div>
    
    <div class="field col-12 md:col-4">
      <label for="type" class="font-bold">
        Tipo <span class="required-asterisk">*</span>
      </label>
      <p-dropdown
        id="type"
        formControlName="type"
        [options]="categoryTypes"
        placeholder="Selecione o tipo"
        styleClass="w-full"
      ></p-dropdown>
    </div>
    
    <div class="field col-12">
      <label for="description" class="font-bold">Descrição</label>
      <textarea 
        id="description"
        pInputTextarea 
        formControlName="description"
        rows="2"
        class="w-full"
        placeholder="Descrição opcional da categoria"
      ></textarea>
    </div>

    <!-- Icon Selection -->
    <div class="field col-12 md:col-6">
      <label for="iconSelector" class="font-bold">
        Ícone <span class="text-red-500">*</span>
      </label>
      <div class="icon-preview mb-2">
        <div class="flex align-items-center gap-2 p-2 border-round surface-border border-1">
          <i 
            [class]="getPreviewIconClass()" 
            [style.color]="getPreviewColor()"
            class="text-xl"
          ></i>
          <span>Pré-visualização</span>
        </div>
      </div>
      <div class="icon-grid">
        <div class="grid">
          <div 
            class="col-2" 
            *ngFor="let icon of availableIcons"
          >
            <button
              type="button"
              class="icon-option p-2 border-round text-center cursor-pointer hover:surface-hover"
              [class.selected]="categoryForm.get('icon')?.value === icon"
              (click)="selectIcon(icon)"
              [attr.aria-label]="'Selecionar ícone ' + icon"
              [title]="icon"
            >
              <i [class]="icon" class="text-lg"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Color Selection -->
    <div class="field col-12 md:col-6">
      <label for="colorSelector" class="font-bold">
        Cor <span class="text-red-500">*</span>
      </label>
      <div class="color-selector">
        <!-- Color Preview Button -->
        <button 
          id="colorSelector"
          type="button"
          class="color-preview-button"
          (click)="showColorPicker = !showColorPicker"
          [attr.aria-expanded]="showColorPicker"
          aria-label="Selecionar cor"
        >
          <div 
            class="color-preview-swatch"
            [style.background-color]="getPreviewColor()"
          ></div>
          <span class="color-preview-text">{{ getPreviewColor() }}</span>
          <i class="pi pi-chevron-down transition-transform" 
             [class.rotate-180]="showColorPicker"></i>
        </button>
        
        <!-- Color Picker Dropdown -->
        <div class="color-picker-dropdown" *ngIf="showColorPicker">
          <div class="color-picker-header">
            <span class="color-picker-title">Selecione uma cor</span>
            <button 
              type="button" 
              class="color-picker-close"
              (click)="showColorPicker = false"
            >
              <i class="pi pi-times"></i>
            </button>
          </div>
          <div class="color-grid">
            <button
              type="button"
              class="color-option"
              *ngFor="let color of availableColors"
              [style.background-color]="color"
              [class.selected]="categoryForm.get('color')?.value === color"
              (click)="selectColor(color)"
              [title]="color"
              [attr.aria-label]="'Selecionar cor ' + color"
            >
              <div class="color-check" *ngIf="categoryForm.get('color')?.value === color">
                <i class="pi pi-check"></i>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="field col-12" *ngIf="editMode">
      <label for="sortOrder" class="font-bold">Ordem de Exibição</label>
      <p-inputNumber
        id="sortOrder"
        formControlName="sortOrder"
        styleClass="w-full"
        placeholder="0"
        [min]="0"
        [max]="999"
        [showButtons]="false"
        [useGrouping]="false"
      ></p-inputNumber>
      <small class="text-color-secondary">
        Ordem para exibição da categoria (0 = primeiro). Menor número aparece primeiro.
      </small>
    </div>
    
    <div class="field col-12" *ngIf="!editMode">
      <small class="text-color-secondary">
        <i class="pi pi-info-circle mr-2"></i>
        A ordem de exibição será definida automaticamente. Você pode alterá-la após criar a categoria.
      </small>
    </div>
  </form>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-content-end gap-2">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        severity="secondary"
        (onClick)="hideDialog()"
      ></p-button>
      <p-button 
        label="Salvar" 
        icon="pi pi-check" 
        (onClick)="saveCategory()"
        [loading]="loading"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>