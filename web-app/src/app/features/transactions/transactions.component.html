<div class="transactions-container">
  <!-- Header with Actions -->
  <div class="card">
    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center mb-4">
      <div class="mb-2 md:mb-0">
        <h2 class="text-2xl font-bold text-color m-0">Transações</h2>
        <p class="text-color-secondary m-0">Gerencie suas receitas e despesas de forma eficiente</p>
      </div>
      <div class="flex gap-2">
        <p-button
          label="Filtros de Projeção"
          icon="pi pi-filter"
          [text]="true"
          size="small"
          (onClick)="toggleProjectionFilters()"
          [badge]="showProjectionFilters ? 'ON' : 'OFF'"
          badgeClass="p-badge-info"
        ></p-button>
        <p-button
          label="Gerenciar Projeções"
          icon="pi pi-cog"
          [text]="true"
          size="small"
          (onClick)="toggleProjectionManager()"
          [badge]="showProjectionManager ? 'ON' : 'OFF'"
          badgeClass="p-badge-warning"
        ></p-button>
        <p-button
          label="Nova Projeção"
          icon="pi pi-clock"
          [outlined]="true"
          size="small"
          (onClick)="openProjectionDialog()"
          styleClass="p-button-info"
        ></p-button>
        <p-button
          label="Nova Transação"
          icon="pi pi-plus"
          size="small"
          (onClick)="openTransactionDialog()"
          styleClass="p-button-primary"
        ></p-button>
      </div>
    </div>

    <!-- Period Filter -->
    <div class="flex flex-column md:flex-row gap-3 align-items-end mb-4">
      <div class="flex-1" style="max-width: 250px">
        <label for="filterPeriod" class="block mb-2 font-medium">Competência</label>
        <p-dropdown
          id="filterPeriod"
          [options]="periodOptions"
          [(ngModel)]="selectedPeriod"
          optionLabel="label"
          optionValue="value"
          placeholder="Todos os períodos"
          [showClear]="true"
          [style]="{ width: '100%' }"
          (onChange)="onPeriodChange()"
          appendTo="body"
        ></p-dropdown>
      </div>
      <div class="flex-1" style="max-width: 200px">
        <label for="filterPaymentStatus" class="block mb-2 font-medium">Status Pagamento</label>
        <p-dropdown
          id="filterPaymentStatus"
          [options]="paymentStatusOptions"
          [(ngModel)]="selectedPaymentStatus"
          optionLabel="label"
          optionValue="value"
          placeholder="Todos"
          [showClear]="true"
          [style]="{ width: '100%' }"
          (onChange)="onPaymentStatusChange()"
          appendTo="body"
        ></p-dropdown>
      </div>
    </div>

    <!-- Projection Filters Panel -->
    <p-panel
      *ngIf="showProjectionFilters"
      header="Filtros de Projeção"
      [toggleable]="false"
      styleClass="mb-3"
    >
      <form [formGroup]="filterForm" class="grid">
        <div class="col-12 md:col-3">
          <label for="includeProjections" class="block text-sm font-medium mb-2"
            >Incluir Projeções</label
          >
          <p-toggleButton
            id="includeProjections"
            formControlName="includeProjections"
            onLabel="Sim"
            offLabel="Não"
            (onChange)="onProjectionFilterChange()"
          ></p-toggleButton>
        </div>

        <div class="col-12 md:col-3">
          <label for="onlyProjections" class="block text-sm font-medium mb-2"
            >Apenas Projeções</label
          >
          <p-toggleButton
            id="onlyProjections"
            formControlName="onlyProjections"
            onLabel="Sim"
            offLabel="Não"
            (onChange)="onProjectionFilterChange()"
          ></p-toggleButton>
        </div>

        <div class="col-12 md:col-3">
          <label for="projectionSource" class="block text-sm font-medium mb-2"
            >Fonte da Projeção</label
          >
          <p-dropdown
            id="projectionSource"
            formControlName="projectionSource"
            [options]="projectionSources"
            optionLabel="label"
            optionValue="value"
            placeholder="Todas as fontes"
            (onChange)="onProjectionFilterChange()"
            styleClass="w-full"
          ></p-dropdown>
        </div>

        <div class="col-12 md:col-3">
          <label for="minConfidence" class="block text-sm font-medium mb-2"
            >Confiança Mínima (%)</label
          >
          <p-inputNumber
            id="minConfidence"
            formControlName="minConfidence"
            [min]="0"
            [max]="100"
            placeholder="0-100"
            (onInput)="onProjectionFilterChange()"
            styleClass="w-full"
          ></p-inputNumber>
        </div>
      </form>
    </p-panel>

    <!-- Projection Management Panel -->
    <p-panel
      *ngIf="showProjectionManager"
      header="Gerenciamento de Projeções"
      [toggleable]="false"
      styleClass="mb-3"
    >
      <div class="projection-actions">
        <div class="proj-card">
          <div class="proj-top">
            <i class="pi pi-refresh text-blue-500 text-4xl mb-2"></i>
            <h5 class="m-0">Gerar Projeções</h5>
            <p class="text-sm text-600 mt-2">
              Cria automaticamente projeções baseadas nas suas transações recorrentes para os
              próximos 6 meses.
            </p>
          </div>
          <div class="proj-actions">
            <p-button
              label="Gerar Projeções"
              icon="pi pi-plus-circle"
              (onClick)="generateProjectionsFromRecurring()"
              [loading]="loading"
              styleClass="w-full p-button-success"
              size="small"
            ></p-button>
          </div>
        </div>

        <div class="proj-card">
          <div class="proj-top">
            <i class="pi pi-calendar-times text-orange-500 text-4xl mb-2"></i>
            <h5 class="m-0">Limpar Projeções Automáticas</h5>
            <p class="text-sm text-600 mt-2">Remove projeções automáticas geradas pelo sistema.</p>
          </div>
          <div class="proj-actions">
            <p-button
              label="Limpar Projeções Automáticas"
              icon="pi pi-trash"
              (onClick)="cleanupSystemProjections()"
              [loading]="loading"
              styleClass="w-full p-button-warning"
              size="small"
            ></p-button>
          </div>
        </div>

        <div class="proj-card">
          <div class="proj-top">
            <i class="pi pi-times-circle text-red-500 text-4xl mb-2"></i>
            <h5 class="m-0">Remover Todas</h5>
            <p class="text-sm text-600 mt-2">Remove completamente todas as projeções existentes no sistema.</p>
          </div>
          <div class="proj-actions">
            <p-button
              label="Remover Todas"
              icon="pi pi-ban"
              (onClick)="cleanupAllProjections()"
              [loading]="loading"
              styleClass="w-full p-button-danger"
              size="small"
            ></p-button>
          </div>
        </div>
      </div>

      <div class="mt-4 p-3 border-1 surface-border border-round">
        <h6 class="text-blue-600 mt-0 mb-2">
          <i class="pi pi-info-circle mr-2"></i>
          Informações sobre Projeções
        </h6>
        <ul class="text-sm text-600 m-0 pl-3">
          <li class="mb-1">
            <strong>Projeções Automáticas:</strong> Baseadas em transações recorrentes ativas
          </li>
          <li class="mb-1">
            <strong>Nível de Confiança:</strong> Indica a probabilidade da projeção se realizar
          </li>
          <li class="mb-1">
            <strong>Período Padrão:</strong> 6 meses à frente a partir do mês seguinte
          </li>
          <li>
            <strong>Atualização:</strong> Recomendamos regenerar mensalmente para manter a precisão
          </li>
        </ul>
      </div>
    </p-panel>
  </div>

  <!-- Transactions Table -->
  <div class="card">
    <p-table
      [value]="transactions"
      [loading]="loading"
      [paginator]="true"
      [rows]="rows"
      [first]="first"
      [totalRecords]="totalRecords"
      [rowsPerPageOptions]="[10, 25, 50]"
      [lazy]="true"
      (onLazyLoad)="onLazyLoad($event)"
      [sortField]="sortField"
      [sortOrder]="sortOrder"
      responsiveLayout="scroll"
    >
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="transactionDate">
            Data <p-sortIcon field="transactionDate"></p-sortIcon>
          </th>
          <th pSortableColumn="description">
            Descrição <p-sortIcon field="description"></p-sortIcon>
          </th>
          <th>Categoria</th>
          <th>Tipo</th>
          <th>Status</th>
          <th pSortableColumn="amount">Valor <p-sortIcon field="amount"></p-sortIcon></th>
          <th class="table-actions-header">Ações</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-transaction>
        <tr [class]="getProjectionClass(transaction)">
          <td>
            <div class="flex align-items-center gap-2">
              <span>{{ transaction.transactionDate | date: 'dd/MM/yyyy' }}</span>
              <i
                *ngIf="isProjectedTransaction(transaction)"
                [class]="'pi ' + getProjectionIcon(transaction) + ' text-blue-500'"
                [pTooltip]="getProjectionTooltip(transaction)"
                class="text-xs"
              ></i>
            </div>
          </td>
          <td>
            <div class="flex flex-column">
              <div class="flex align-items-center gap-2">
                <span class="font-semibold">{{ transaction.description }}</span>
                <p-tag
                  *ngIf="isProjectedTransaction(transaction)"
                  value="PROJEÇÃO"
                  severity="info"
                  [style]="{ 'font-size': '0.7rem', padding: '0.2rem 0.4rem' }"
                ></p-tag>
              </div>
              <span class="text-sm text-600" *ngIf="transaction.notes">{{
                transaction.notes
              }}</span>
              <div
                *ngIf="isProjectedTransaction(transaction) && transaction.confidenceScore"
                class="text-xs mt-1"
              >
                <span>Confiança: </span>
                <span [style]="{ color: getConfidenceColor(transaction.confidenceScore) }">
                  {{ transaction.confidenceScore }}%
                </span>
              </div>
            </div>
          </td>
          <td>
            <div class="flex align-items-center gap-2" *ngIf="transaction.category">
              <i
                [class]="normalizeIcon(transaction.category.icon)"
                [style.color]="transaction.category.color"
              ></i>
              <span>{{ transaction.category.name }}</span>
            </div>
          </td>
          <td>
            <p-tag
              [value]="transaction.type === 'income' ? 'Receita' : 'Despesa'"
              [severity]="transaction.type === 'income' ? 'success' : 'danger'"
            ></p-tag>
          </td>
          <td>
            <p-tag
              *ngIf="!isProjectedTransaction(transaction)"
              [value]="getPaymentStatusLabel(transaction.paymentStatus)"
              [severity]="getPaymentStatusSeverity(transaction)"
              [pTooltip]="getPaymentStatusTooltip(transaction)"
            ></p-tag>
            <span *ngIf="isProjectedTransaction(transaction)" class="text-500 text-sm">-</span>
          </td>
          <td>
            <span
              [class]="transaction.type === 'income' ? 'text-green-600' : 'text-red-600'"
              class="font-semibold"
            >
              {{ transaction.amount | currency: 'BRL' : 'symbol' : '1.2-2' : 'pt-BR' }}
            </span>
          </td>
          <td>
            <div class="table-actions">
              <p-button
                *ngIf="canMarkAsPaid(transaction)"
                icon="pi pi-check"
                (click)="confirmPayTransaction(transaction)"
                styleClass="p-button-text p-button-success p-button-sm"
                pTooltip="Marcar como Pago"
              ></p-button>
              <p-button
                *ngIf="canRevertPayment(transaction)"
                icon="pi pi-undo"
                (click)="confirmRevertPayment(transaction)"
                styleClass="p-button-text p-button-warning p-button-sm"
                pTooltip="Reverter Pagamento"
              ></p-button>
              <p-button
                icon="pi pi-pencil"
                (click)="editTransaction(transaction)"
                styleClass="p-button-text p-button-sm"
                pTooltip="Editar"
              ></p-button>
              <p-button
                icon="pi pi-trash"
                (click)="deleteTransaction(transaction)"
                styleClass="p-button-text p-button-danger p-button-sm"
                pTooltip="Excluir"
              ></p-button>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7">
            <div class="table-empty-state">
              <i class="pi pi-inbox table-empty-icon"></i>
              <span class="table-empty-title">Nenhuma transação encontrada</span>
              <p-button
                label="Adicionar Primeira Transação"
                icon="pi pi-plus"
                (click)="openTransactionDialog()"
                styleClass="p-button-primary table-empty-action"
              ></p-button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Transaction Dialog -->
  <p-dialog
    header="{{ editingTransaction ? 'Editar Transação' : 'Nova Transação' }}"
    [(visible)]="showTransactionDialog"
    [modal]="true"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    styleClass="p-dialog-maximized md:p-dialog-default"
    [style]="{ width: '500px' }"
  >
    <form [formGroup]="transactionForm" (ngSubmit)="saveTransaction()">
      <!-- Type Selection -->
      <div class="field mb-4">
        <label class="block text-sm font-medium mb-2">
          Tipo <span class="required-asterisk">*</span>
        </label>
        <p-dropdown
          formControlName="type"
          [options]="getTypeOptions()"
          optionLabel="label"
          optionValue="value"
          placeholder="Selecione o tipo"
          styleClass="w-full"
        ></p-dropdown>
      </div>

      <!-- Amount -->
      <div class="field mb-4">
        <label for="amount" class="block text-sm font-medium mb-2">
          Valor <span class="required-asterisk">*</span>
        </label>
        <p-inputNumber
          id="amount"
          formControlName="amount"
          mode="currency"
          currency="BRL"
          locale="pt-BR"
          placeholder="0,00"
          styleClass="w-full"
        ></p-inputNumber>
        <small class="text-red-500" *ngIf="submitted && transactionForm.get('amount')?.invalid">
          Valor é obrigatório
        </small>
      </div>

      <!-- Description -->
      <div class="field mb-4">
        <label for="description" class="block text-sm font-medium mb-2">
          Descrição <span class="required-asterisk">*</span>
        </label>
        <input
          id="description"
          type="text"
          pInputText
          formControlName="description"
          placeholder="Descrição da transação"
          class="w-full"
        />
        <small
          class="text-red-500"
          *ngIf="submitted && transactionForm.get('description')?.invalid"
        >
          Descrição é obrigatória
        </small>
      </div>

      <!-- Category -->
      <div class="field mb-4">
        <label for="categoryId" class="block text-sm font-medium mb-2">
          Categoria <span class="required-asterisk">*</span>
        </label>
        <p-dropdown
          id="categoryId"
          formControlName="categoryId"
          [options]="getCategoryDropdownOptions()"
          placeholder="Selecione a categoria"
          styleClass="w-full"
        >
          <ng-template let-category pTemplate="selectedItem">
            <div class="flex align-items-center gap-2" *ngIf="category">
              <i [class]="category.icon" [style.color]="category.color"></i>
              <span>{{ category.label }}</span>
            </div>
          </ng-template>
          <ng-template let-category pTemplate="item">
            <div class="flex align-items-center gap-2">
              <i [class]="category.icon" [style.color]="category.color"></i>
              <span>{{ category.label }}</span>
            </div>
          </ng-template>
        </p-dropdown>
        <small class="text-red-500" *ngIf="submitted && transactionForm.get('categoryId')?.invalid">
          Categoria é obrigatória
        </small>
      </div>

      <!-- Date -->
      <div class="field mb-4">
        <label for="transactionDate" class="block text-sm font-medium mb-2">
          Data <span class="required-asterisk">*</span>
        </label>
        <p-calendar
          appDateMask="date"
          id="transactionDate"
          formControlName="transactionDate"
          placeholder="dd/mm/aaaa"
          dateFormat="dd/mm/yy"
          styleClass="w-full"
          [showIcon]="true"
          appendTo="body"
          (onSelect)="onTransactionDateChange()"
        ></p-calendar>
        <small
          class="text-red-500"
          *ngIf="submitted && transactionForm.get('transactionDate')?.invalid"
        >
          Data é obrigatória
        </small>
      </div>

      <!-- Competency Period -->
      <div class="field mb-4">
        <label for="competencyPeriod" class="block text-sm font-medium mb-2">
          Período de Competência <span class="required-asterisk">*</span>
        </label>
        <p-calendar
          appDateMask="month"
          id="competencyPeriod"
          formControlName="competencyPeriod"
          placeholder="mm/aaaa"
          dateFormat="mm/yy"
          view="month"
          styleClass="w-full"
          [showIcon]="true"
          appendTo="body"
        ></p-calendar>
        <small class="text-color-secondary text-xs mt-1 block">
          Define em qual mês esta transação aparecerá nas estatísticas
        </small>
        <small
          class="text-red-500"
          *ngIf="submitted && transactionForm.get('competencyPeriod')?.invalid"
        >
          Período de competência é obrigatório
        </small>
      </div>

      <!-- Notes -->
      <div class="field mb-4">
        <label for="notes" class="block text-sm font-medium mb-2"> Observações </label>
        <textarea
          id="notes"
          pInputTextarea
          formControlName="notes"
          placeholder="Observações adicionais (opcional)"
          rows="3"
          class="w-full"
        ></textarea>
      </div>

      <!-- Projection Settings -->
      <p-panel
        header="Configurações de Projeção"
        [toggleable]="true"
        [collapsed]="!isProjectedFormEnabled()"
        styleClass="projection-settings-panel"
      >
        <!-- Is Projected Toggle -->
        <div class="field mb-3">
          <div class="flex align-items-center flex-wrap gap-2">
            <p-toggleButton
              id="isProjected"
              formControlName="isProjected"
              onLabel="Transação Projetada"
              offLabel="Transação Real"
              (onChange)="onProjectedToggle()"
            ></p-toggleButton>
            <small class="text-600">
              Transações projetadas são estimativas para planejamento futuro
            </small>
          </div>
        </div>

        <!-- Projection Source -->
        <div class="field mb-3" *ngIf="isProjectedFormEnabled()">
          <label for="formProjectionSource" class="block text-sm font-medium mb-2">
            Fonte da Projeção
          </label>
          <p-dropdown
            id="formProjectionSource"
            formControlName="projectionSource"
            [options]="projectionSources"
            optionLabel="label"
            optionValue="value"
            placeholder="Selecione a fonte"
            styleClass="w-full"
          ></p-dropdown>
        </div>

        <!-- Confidence Score -->
        <div class="field mb-3" *ngIf="isProjectedFormEnabled()">
          <label for="confidenceScore" class="block text-sm font-medium mb-2">
            Nível de Confiança (%)
          </label>
          <p-inputNumber
            id="confidenceScore"
            formControlName="confidenceScore"
            [min]="0"
            [max]="100"
            placeholder="80"
            mode="decimal"
            [step]="5"
            styleClass="w-full"
          ></p-inputNumber>
          <small class="text-600">
            Indica o quão provável é esta transação acontecer (0-100%)
          </small>
        </div>
      </p-panel>

      <!-- Action Buttons -->
      <div class="dialog-actions flex justify-content-end gap-2 mt-4 pt-3">
        <p-button
          label="Cancelar"
          icon="pi pi-times"
          (click)="closeTransactionDialog()"
          styleClass="p-button-text"
          type="button"
        ></p-button>
        <p-button
          [label]="editingTransaction ? 'Atualizar' : 'Salvar'"
          icon="pi pi-check"
          type="submit"
          [loading]="loading"
        ></p-button>
      </div>
    </form>
  </p-dialog>
</div>
