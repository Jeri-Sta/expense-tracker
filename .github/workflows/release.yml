name: ğŸ·ï¸ Release Management

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Tipo de versÃ£o para release'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
      confirm_release:
        description: 'Confirmar criaÃ§Ã£o do release (digite "CONFIRMAR")'
        required: true
        type: string
permissions:
  issues: write
  contents: write

env:
  NODE_VERSION: '18'

jobs:
  validate-and-prepare:
    name: ğŸ” Validar e Preparar Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      new-version: ${{ steps.version-info.outputs.new-version }}
      old-version: ${{ steps.version-info.outputs.old-version }}
      release-notes: ${{ steps.version-info.outputs.release-notes }}
      backup-branch: ${{ steps.version-info.outputs.backup-branch }}
    
    steps:
      - name: âœ… Verificar confirmaÃ§Ã£o
        if: inputs.confirm_release != 'CONFIRMAR'
        run: |
          echo "âŒ Release nÃ£o confirmado. Digite 'CONFIRMAR' para prosseguir."
          exit 1

      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_TOKEN }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”§ Configurar Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: ğŸ“‹ Executar version bump
        id: version-bump
        run: |
          echo "ğŸš€ Executando version bump para: ${{ inputs.version_type }}"
          cd scripts
          node version-bump.js ${{ inputs.version_type }}

      - name: ğŸ“Š Extrair informaÃ§Ãµes de versÃ£o
        id: version-info
        run: |
          if [ -f "release-info.json" ]; then
            NEW_VERSION=$(jq -r '.newVersion' release-info.json)
            OLD_VERSION=$(jq -r '.oldVersion' release-info.json)
            RELEASE_NOTES=$(jq -r '.releaseNotes' release-info.json)
            BACKUP_BRANCH=$(jq -r '.backupBranch' release-info.json)
            
            echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "old-version=$OLD_VERSION" >> $GITHUB_OUTPUT
            echo "backup-branch=$BACKUP_BRANCH" >> $GITHUB_OUTPUT
            
            # Para release notes multiline, usa um delimiter
            echo "release-notes<<EOF" >> $GITHUB_OUTPUT
            echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "âœ… Nova versÃ£o preparada: $OLD_VERSION â†’ $NEW_VERSION"
          else
            echo "âŒ Arquivo release-info.json nÃ£o encontrado"
            exit 1
          fi

      - name: ğŸ’¾ Upload release info
        uses: actions/upload-artifact@v4
        with:
          name: release-info
          path: release-info.json
          retention-days: 1

  run-tests:
    name: ğŸ§ª Executar Testes Completos
    needs: validate-and-prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [backend, frontend]
        
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ matrix.component == 'backend' && 'api/package-lock.json' || 'web-app/package-lock.json' }}

      - name: ğŸ“¦ Instalar dependÃªncias - Backend
        if: matrix.component == 'backend'
        working-directory: api
        run: npm ci

      - name: ğŸ” Executar linter - Backend
        if: matrix.component == 'backend'
        working-directory: api
        run: npm run lint

      - name: ğŸ§ª Executar testes - Backend
        if: matrix.component == 'backend'
        working-directory: api
        run: npm run test

      - name: ğŸ—ï¸ Build - Backend
        if: matrix.component == 'backend'
        working-directory: api
        run: npm run build

      - name: ğŸ“¦ Instalar dependÃªncias - Frontend
        if: matrix.component == 'frontend'
        working-directory: web-app
        run: npm ci

      - name: ğŸ” Executar linter - Frontend
        if: matrix.component == 'frontend'
        working-directory: web-app
        run: npm run lint

      - name: ğŸ§ª Executar testes - Frontend
        if: matrix.component == 'frontend'
        working-directory: web-app
        run: npm run test -- --browsers=ChromeHeadless --watch=false

      - name: ğŸ—ï¸ Build - Frontend
        if: matrix.component == 'frontend'
        working-directory: web-app
        run: npm run build:prod

  create-release:
    name: ğŸš€ Criar Release
    needs: [validate-and-prepare, run-tests]
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_TOKEN }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”§ Configurar Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: ğŸ“¥ Download release info
        uses: actions/download-artifact@v4
        with:
          name: release-info

      - name: ğŸ”„ Re-executar version bump
        run: |
          echo "ğŸ”„ Re-executando version bump apÃ³s validaÃ§Ã£o dos testes..."
          cd scripts
          node version-bump.js ${{ inputs.version_type }}

      - name: ğŸ“ Commit mudanÃ§as de versÃ£o
        run: |
          git add .
          git commit -m "ğŸ·ï¸ Release v${{ needs.validate-and-prepare.outputs.new-version }}

          - Bump version from ${{ needs.validate-and-prepare.outputs.old-version }} to ${{ needs.validate-and-prepare.outputs.new-version }}
          - Update package.json files
          - Update environment files  
          - Update CHANGELOG.md
          
          Type: ${{ inputs.version_type }}
          Backup: ${{ needs.validate-and-prepare.outputs.backup-branch }}"

      - name: ğŸ·ï¸ Criar tag
        run: |
          git tag -a "v${{ needs.validate-and-prepare.outputs.new-version }}" -m "Release v${{ needs.validate-and-prepare.outputs.new-version }}"

      - name: ğŸ“¤ Push mudanÃ§as e tag
        run: |
          git push origin main
          git push origin "v${{ needs.validate-and-prepare.outputs.new-version }}"

      - name: ğŸ—ï¸ Build final para release - Backend
        working-directory: api
        run: |
          npm ci
          npm run build

      - name: ğŸ—ï¸ Build final para release - Frontend
        working-directory: web-app
        run: |
          npm ci
          npm run build:prod

      - name: ğŸ“¦ Criar artifacts
        run: |
          # Criar diretÃ³rio para artifacts
          mkdir -p release-artifacts
          
          # Backend artifact
          cd api
          tar -czf ../release-artifacts/expense-tracker-api-v${{ needs.validate-and-prepare.outputs.new-version }}.tar.gz dist/
          cd ..
          
          # Frontend artifact
          cd web-app
          tar -czf ../release-artifacts/expense-tracker-web-v${{ needs.validate-and-prepare.outputs.new-version }}.tar.gz dist/
          cd ..
          
          # Source code artifact
          git archive --format=tar.gz --prefix=expense-tracker-v${{ needs.validate-and-prepare.outputs.new-version }}/ HEAD > release-artifacts/expense-tracker-source-v${{ needs.validate-and-prepare.outputs.new-version }}.tar.gz

      - name: ğŸ‰ Criar GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate-and-prepare.outputs.new-version }}
          name: Release v${{ needs.validate-and-prepare.outputs.new-version }}
          body: |
            # ğŸ‰ Personal Expense Tracker v${{ needs.validate-and-prepare.outputs.new-version }}
            
            ## ğŸ“‹ MudanÃ§as nesta versÃ£o
            
            ${{ needs.validate-and-prepare.outputs.release-notes }}
            
            ## ğŸ“¦ Artifacts
            
            - **API Backend**: `expense-tracker-api-v${{ needs.validate-and-prepare.outputs.new-version }}.tar.gz`
            - **Web Frontend**: `expense-tracker-web-v${{ needs.validate-and-prepare.outputs.new-version }}.tar.gz` 
            - **CÃ³digo Fonte**: `expense-tracker-source-v${{ needs.validate-and-prepare.outputs.new-version }}.tar.gz`
            
            ## ğŸ”„ Tipo de Release
            
            **${{ inputs.version_type }}**: ${{ needs.validate-and-prepare.outputs.old-version }} â†’ ${{ needs.validate-and-prepare.outputs.new-version }}
            
            ## ğŸ“… Data
            
            ${{ github.event.head_commit.timestamp }}
            
            ---
            
            ğŸ’¡ **Como usar**: Baixe os artifacts acima e siga as instruÃ§Ãµes do README.md para deployment.
            
            ğŸ”’ **Backup**: Branch de backup criado: `${{ needs.validate-and-prepare.outputs.backup-branch }}`
          files: |
            release-artifacts/*.tar.gz
          draft: false
          prerelease: false

  cleanup:
    name: ğŸ§¹ Limpeza
    needs: [validate-and-prepare, create-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ—‘ï¸ Limpar artifacts temporÃ¡rios
        run: |
          echo "âœ… Limpeza concluÃ­da"
          echo "ğŸ“‹ Release info disponÃ­vel por 24h para debugging"

  rollback:
    name: ğŸ”„ Rollback AutomÃ¡tico
    needs: [validate-and-prepare, run-tests, create-release]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_TOKEN }}

      - name: ğŸ”§ Configurar Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: ğŸ”„ Executar rollback
        run: |
          echo "âŒ Release falhou. Executando rollback automÃ¡tico..."
          
          # Verificar se tag foi criada e removÃª-la
          if git tag -l | grep -q "v${{ needs.validate-and-prepare.outputs.new-version }}"; then
            echo "ğŸ—‘ï¸ Removendo tag v${{ needs.validate-and-prepare.outputs.new-version }}..."
            git tag -d "v${{ needs.validate-and-prepare.outputs.new-version }}" || true
            git push --delete origin "v${{ needs.validate-and-prepare.outputs.new-version }}" || true
          fi
          
          # Restaurar do backup se disponÃ­vel
          BACKUP_BRANCH="${{ needs.validate-and-prepare.outputs.backup-branch }}"
          if [ -n "$BACKUP_BRANCH" ] && git branch -r | grep -q "origin/$BACKUP_BRANCH"; then
            echo "â™»ï¸ Restaurando do backup: $BACKUP_BRANCH"
            git checkout "$BACKUP_BRANCH"
            git checkout -b rollback-temp
            git checkout main
            git reset --hard rollback-temp
            git push --force-with-lease origin main
            git branch -D rollback-temp
            echo "âœ… Rollback concluÃ­do. Estado restaurado do backup."
          else
            echo "âš ï¸ Backup nÃ£o disponÃ­vel. Rollback manual necessÃ¡rio."
          fi

      - name: ğŸ“ Criar issue de rollback
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Rollback AutomÃ¡tico - Release v${{ needs.validate-and-prepare.outputs.new-version }} Falhou`,
              body: `## âš ï¸ Release AutomÃ¡tico Falhou
              
              O processo de release para a versÃ£o **v${{ needs.validate-and-prepare.outputs.new-version }}** falhou e foi executado um rollback automÃ¡tico.
              
              ### ğŸ“Š InformaÃ§Ãµes do Release
              - **VersÃ£o anterior**: ${{ needs.validate-and-prepare.outputs.old-version }}
              - **Nova versÃ£o**: ${{ needs.validate-and-prepare.outputs.new-version }}
              - **Tipo**: ${{ inputs.version_type }}
              - **Branch de backup**: ${{ needs.validate-and-prepare.outputs.backup-branch }}
              
              ### ğŸ” PrÃ³ximos Passos
              1. Verificar os logs do workflow para identificar a causa da falha
              2. Corrigir os problemas identificados
              3. Tentar o release novamente
              
              ### ğŸ“‹ Links Ãšteis
              - [Workflow que falhou](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              - [Commit atual](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
              
              _Issue criada automaticamente pelo sistema de rollback_`,
              labels: ['bug', 'release', 'rollback', 'urgent']
            })